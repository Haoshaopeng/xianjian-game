<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›·æ³•æ— é—´ï¼šé€é¥æ¸¸ (v8.3 æ˜¾è¡€ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700&display=swap');
        
        body { 
            margin: 0; overflow: hidden; background-color: #87CEEB; 
            font-family: 'Noto Serif SC', serif; 
            touch-action: none; user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        #gameCanvas3D { position: absolute; top: 0; left: 0; z-index: 1; }
        #hudCanvas { position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none; }

        /* æ°›å›´å±‚ */
        .mist-overlay {
            position: fixed; inset: 0; z-index: 5; pointer-events: none;
            background: radial-gradient(circle at center, transparent 40%, rgba(255,255,255,0.5) 100%);
            mix-blend-mode: screen;
        }

        /* UI é¢æ¿ */
        .cultivation-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #d4af37;
            border-radius: 8px;
            color: #5d4037;
            pointer-events: auto;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            backdrop-filter: blur(8px);
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .taoist-btn {
            background: linear-gradient(180deg, #fffcf5 0%, #e6dace 100%);
            border: 2px solid #d4af37;
            color: #8b4500;
            font-family: 'Ma Shan Zheng', cursive;
            display: flex; align-items: center; justify-content: center;
            position: absolute; /* æ”¹ä¸ºç»å¯¹å®šä½ä»¥ä¾¿å¸ƒå±€ */
            transition: transform 0.1s;
            box-shadow: 0 4px 0 #b08d55;
            overflow: hidden;
            border-radius: 50%;
            pointer-events: auto; 
            z-index: 30;
        }
        .taoist-btn:active { transform: scale(0.95); box-shadow: 0 0 0 #b08d55; }
        
        /* æŠ€èƒ½å†·å´é®ç½© */
        .cd-mask {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0;
            background: rgba(0,0,0,0.5); transition: height 0.1s linear;
        }

        .btn-ult {
            border-color: #ff3333; color: #ff3333;
            background: linear-gradient(180deg, #fff5f5 0%, #ffcccc 100%);
            box-shadow: 0 4px 0 #cc0000;
        }
        .btn-ult:active { box-shadow: 0 0 0 #cc0000; }

        /* çŠ¶æ€æ¡ */
        .bar-container { height: 14px; background: #ddd; margin-top: 6px; border-radius: 7px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.3s; }
        .bar-text { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #fff; font-weight: bold; text-shadow: 0 0 2px #000;
            z-index: 2;
        }
        .hp-fill { background: linear-gradient(90deg, #ff6b6b, #ee0000); }
        .xp-fill { background: linear-gradient(90deg, #ffd700, #ffaa00); }

        /* ç­”é¢˜æ¡† */
        #quizModal { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #quizBox {
            width: 90%; max-width: 500px;
            background: #fff;
            color: #333;
            border: 4px solid #d4af37;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* è§¦æ‘¸åˆ†åŒº */
        #touchZoneLeft { position: absolute; top:0; left:0; width: 50%; height: 100%; z-index: 20; pointer-events: auto; }
        #touchZoneRight { position: absolute; top:0; left:50%; width: 50%; height: 100%; z-index: 20; pointer-events: auto; }
        
        #startScreen, #winScreen {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(240, 248, 255, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.5s;
        }
        
        .ink-text { font-family: 'Ma Shan Zheng', cursive; }
        
        /* æŠ€èƒ½ç›˜å®¹å™¨ - å³ä¸‹è§’ */
        #skillContainer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 180px;
            pointer-events: none; /* è®©è§¦æ‘¸ç©¿é€ç©ºç™½åŒº */
        }
    </style>
</head>
<body>

    <div class="mist-overlay"></div>
    <canvas id="gameCanvas3D"></canvas>
    <canvas id="hudCanvas"></canvas>

    <!-- è§¦æ‘¸å±‚: å·¦ç§» å³è§† -->
    <div id="touchZoneLeft"></div>
    <div id="touchZoneRight"></div>

    <div class="ui-layer p-4 flex flex-col justify-between pointer-events-none">
        <!-- Top -->
        <div class="flex justify-between items-start select-none w-full pointer-events-auto">
            <div class="cultivation-panel p-3 w-64 shadow-lg">
                <div class="flex justify-between text-xs text-gray-500 mb-1 font-bold">
                    <span>é“å·: é›·äº‘å­</span>
                    <span class="text-orange-600"><span id="levelDisplay">ç»ƒæ°”ä¸€å±‚</span></span>
                </div>
                <div class="flex items-end justify-between mb-1">
                    <span id="voltageDisplay" class="text-xl font-bold text-yellow-600 ink-text">ä¿®ä»™é¢æ¿</span>
                </div>
                <!-- HP Bar with Text -->
                <div class="bar-container">
                    <span id="hpText" class="bar-text">HP: 220/1000</span>
                    <div id="hpBar" class="bar-fill hp-fill" style="width: 100%"></div>
                </div>
                <!-- XP Bar with Text -->
                <div class="bar-container">
                    <span id="xpText" class="bar-text">XP: 0/100</span>
                    <div id="xpBar" class="bar-fill xp-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="flex gap-2">
                 <button class="cultivation-panel w-10 h-10 flex items-center justify-center text-lg rounded-full" onclick="toggleMute()">
                    <span id="muteIcon">ğŸ”Š</span>
                </button>
                <div class="cultivation-panel p-1 rounded-full border-none" style="width: 80px; height: 80px; overflow: hidden; padding: 0;">
                    <canvas id="minimapCanvas" width="80" height="80" class="bg-blue-50"></canvas>
                </div>
            </div>
        </div>

        <div id="killFeed" class="absolute top-40 left-4 text-sm space-y-1 opacity-90 w-64 text-gray-800 font-bold" style="text-shadow: 0 0 2px white;"></div>

        <!-- Log Area -->
        <div class="absolute bottom-4 left-4 cultivation-panel p-2 w-48 hidden md:block h-32 flex flex-col opacity-80 pointer-events-none">
            <div id="logArea" class="flex-1 overflow-y-auto text-xs text-gray-600 scrollbar-hide space-y-1"></div>
        </div>

        <!-- Right Bottom Skill Container (MOBA Layout) -->
        <div id="skillContainer">
            <!-- æ™®æ”» (æœ€å¤§, å³ä¸‹è§’) -->
            <div id="fireBtn" class="taoist-btn w-24 h-24 text-5xl font-bold border-yellow-500 text-yellow-700 bg-yellow-50 shadow-lg" 
                 style="bottom: 0; right: 0;"
                 ontouchstart="startFire()" ontouchend="stopFire()" onmousedown="startFire()" onmouseup="stopFire()">
                å‰‘
            </div>

            <!-- åŠ é€Ÿ (å°, æ™®æ”»å·¦ä¾§) -->
            <div class="taoist-btn w-14 h-14 text-xl bg-green-50 text-green-600 border-green-300"
                 style="bottom: 10px; right: 110px;"
                 onclick="activateSkill('speed')">
                é
                <div id="skillCd2" class="cd-mask"></div>
            </div>

            <!-- æŠ¤ç›¾ (å°, æ™®æ”»ä¸Šæ–¹) -->
            <div class="taoist-btn w-14 h-14 text-xl bg-blue-50 text-blue-600 border-blue-300"
                 style="bottom: 110px; right: 10px;"
                 onclick="activateSkill('shield')">
                ç½©
                <div id="skillCd1" class="cd-mask"></div>
            </div>

            <!-- å¤§æ‹› (ä¸­, æ™®æ”»å·¦ä¸Šæ–¹) -->
            <div class="taoist-btn btn-ult w-18 h-18 text-3xl font-bold"
                 style="bottom: 80px; right: 80px; width: 70px; height: 70px;"
                 onclick="triggerUltimate()">
                é›·
                <div id="ultCd" class="cd-mask"></div>
            </div>
        </div>
    </div>

    <!-- Quiz -->
    <div id="quizModal">
        <div id="quizBox">
            <div class="bg-yellow-50 p-4 text-center border-b border-yellow-200 rounded-t-lg">
                <span id="quizTitle" class="font-bold text-yellow-800 text-2xl ink-text">é“æ³•è€ƒéªŒ</span>
            </div>
            <div id="quizTimerBar" class="h-1 bg-yellow-500 w-full transition-all duration-100 ease-linear"></div>
            <div class="p-6">
                <p id="quizQuestion" class="text-xl mb-6 text-gray-800 font-bold text-center">...</p>
                <div id="quizOptions" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>
    </div>

    <!-- Start -->
    <div id="startScreen">
        <h1 class="text-7xl md:text-9xl font-bold text-yellow-600 ink-text mb-4 drop-shadow-xl">é›·æ³•æ— é—´</h1>
        <div class="text-2xl text-gray-500 mb-12 font-bold tracking-[0.5em]">é€é¥æ¸¸ Â· ä»™ç•Œç¯‡</div>
        <button class="relative bg-gradient-to-b from-[#fffcf5] to-[#e6dace] border-2 border-[#d4af37] text-[#8b4500] font-[Ma_Shan_Zheng] px-20 py-6 text-3xl rounded-full hover:scale-105 shadow-xl transition-transform" style="pointer-events: auto;" onclick="startGame()">
            è¸å…¥ä»™é€”
        </button>
        <div class="text-gray-500 text-sm mt-8 font-mono bg-white/50 px-4 py-2 rounded">
            å·¦å±æ‘‡æ†ç§»åŠ¨ Â· å³å±æ»‘åŠ¨æ—‹è½¬è§†è§’ Â· å³ä¸‹å¾¡å‰‘
        </div>
    </div>

    <!-- Win -->
    <div id="winScreen" style="display:none">
        <h1 class="text-8xl font-bold text-yellow-600 ink-text mb-6">è¯é“é£å‡</h1>
        <p class="text-2xl text-gray-600 mb-12">ä¹å¤©ååœ° Â· å”¯æˆ‘ç‹¬å°Š</p>
        <button class="relative bg-gradient-to-b from-[#fffcf5] to-[#e6dace] border-2 border-[#d4af37] text-[#8b4500] font-[Ma_Shan_Zheng] px-12 py-5 text-2xl rounded-full hover:scale-105 shadow-xl transition-transform" style="pointer-events: auto;" onclick="location.reload()">å†å…¥è½®å›</button>
    </div>

    <script>
        /** * é›·æ³•æ— é—´ v8.3 - æ˜¾è¡€ç‰ˆ */

        // --- 1. Audio ---
        const AudioSys = {
            ctx: null, muted: false,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)();
                if(this.ctx.state==='suspended') this.ctx.resume();
            },
            playTone: function(freq, type, dur, vol=0.1) {
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            },
            speak: function(text) {
                if(this.muted || !window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-CN'; u.rate = 1.2;
                window.speechSynthesis.speak(u);
            },
            stopSpeak: function() { if(window.speechSynthesis) window.speechSynthesis.cancel(); },
            sword: function() { this.playTone(800, 'triangle', 0.1, 0.1); },
            gong: function() { this.playTone(150, 'sine', 0.5, 0.2); },
            thunder: function() { 
                if(this.muted||!this.ctx)return;
                const o = this.ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=50;
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.2, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.5);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5);
            }
        };
        function toggleMute() { 
            AudioSys.muted = !AudioSys.muted; 
            document.getElementById('muteIcon').innerText = AudioSys.muted ? 'ğŸ”‡' : 'ğŸ”Š'; 
            if(AudioSys.muted) AudioSys.stopSpeak();
        }

        // --- 2. Input System ---
        let input = { 
            moveActive: false, moveAngle: 0, movePower: 0,
            camAngle: 0, fire: false, keys: {} 
        };
        
        let leftTouch = { id: null, startX:0, startY:0, curX:0, curY:0 };
        let rightTouch = { id: null, lastX:0 };

        function initInput() {
            window.addEventListener('keydown', e => { 
                input.keys[e.code]=true; 
                if(STATE.mode==='PLAYING'){ 
                    if(e.code==='Space') activateSkill('shield'); 
                    if(e.code==='ShiftLeft') activateSkill('speed'); 
                    if(e.code==='KeyR') triggerUltimate();
                    if(e.code==='KeyQ') input.camAngle += 0.05;
                    if(e.code==='KeyE') input.camAngle -= 0.05;
                }
            });
            window.addEventListener('keyup', e => input.keys[e.code]=false);

            const zoneL = document.getElementById('touchZoneLeft');
            zoneL.addEventListener('touchstart', e => {
                e.preventDefault();
                const t = e.changedTouches[0];
                if(leftTouch.id === null) {
                    leftTouch.id = t.identifier;
                    leftTouch.startX = t.clientX; leftTouch.startY = t.clientY;
                    leftTouch.curX = t.clientX; leftTouch.curY = t.clientY;
                    input.moveActive = true;
                    AudioSys.init();
                }
            }, {passive:false});
            
            zoneL.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let i=0; i<e.changedTouches.length; i++) {
                    if(e.changedTouches[i].identifier === leftTouch.id) {
                        const t = e.changedTouches[i];
                        leftTouch.curX = t.clientX; leftTouch.curY = t.clientY;
                        const dx = leftTouch.curX - leftTouch.startX;
                        const dy = leftTouch.curY - leftTouch.startY;
                        const dist = Math.hypot(dx, dy);
                        input.moveAngle = Math.atan2(dy, dx);
                        input.movePower = Math.min(dist/70, 1.0);
                    }
                }
            }, {passive:false});

            const endL = e => {
                for(let i=0; i<e.changedTouches.length; i++) {
                    if(e.changedTouches[i].identifier === leftTouch.id) {
                        input.moveActive = false; input.movePower = 0; leftTouch.id = null;
                    }
                }
            };
            zoneL.addEventListener('touchend', endL); zoneL.addEventListener('touchcancel', endL);

            const zoneR = document.getElementById('touchZoneRight');
            zoneR.addEventListener('touchstart', e => {
                const t = e.changedTouches[0];
                if(rightTouch.id === null) {
                    rightTouch.id = t.identifier;
                    rightTouch.lastX = t.clientX;
                }
            }, {passive:false});

            zoneR.addEventListener('touchmove', e => {
                e.preventDefault(); 
                for(let i=0; i<e.changedTouches.length; i++) {
                    if(e.changedTouches[i].identifier === rightTouch.id) {
                        const t = e.changedTouches[i];
                        const deltaX = t.clientX - rightTouch.lastX;
                        input.camAngle -= deltaX * 0.005; 
                        rightTouch.lastX = t.clientX;
                    }
                }
            }, {passive:false});

            const endR = e => {
                for(let i=0; i<e.changedTouches.length; i++) {
                    if(e.changedTouches[i].identifier === rightTouch.id) rightTouch.id = null;
                }
            };
            zoneR.addEventListener('touchend', endR); zoneR.addEventListener('touchcancel', endR);
        }

        // --- 3. Config ---
        const CFG = { mapSize: 4000, gridSize: 100 };
        const STATE = { mode: 'MENU', time: 0 };
        const QUESTION_DB = {
            simple: [ {q:"ç”µæµå•ä½?", o:["å®‰åŸ¹","ä¼ç‰¹","æ¬§å§†","ç“¦ç‰¹"], a:0}, {q:"çº¢è‰²è‰²ç¯?", o:["1","2","3","0"], a:1}, {q:"å®¶åº­ç”µå‹?", o:["220V","110V","380V","12V"], a:0}, {q:"ç”µå®¹å•ä½?", o:["æ³•æ‹‰","äº¨åˆ©","ç„¦è€³","åº“ä»‘"], a:0} ],
            hard: [ {q:"ä¸‰ç›¸ç”µç›¸è§’?", o:["120åº¦","90åº¦","180åº¦","60åº¦"], a:0}, {q:"P=UI è®¡ç®—?", o:["ç”µåŠŸç‡","ç”µåŠŸ","çƒ­é‡","ç”µé˜»"], a:0}, {q:"æ¼ä¿æ£€æµ‹?", o:["é›¶åºç”µæµ","è¿‡è½½","çŸ­è·¯","ç”µå‹"], a:0} ]
        };
        const REALMS = ["ç»ƒæ°”", "ç­‘åŸº", "é‡‘ä¸¹", "å…ƒå©´", "åŒ–ç¥", "æ¸¡åŠ«", "å¤§ä¹˜"];
        
        let player = { x:0, y:0, r:20, v:220, maxV:1000, xp:0, lvl:1, nextXp:100, baseSpeed: 3.5, skills:{shield:0, speed:0}, ultCd:0, shootCd:0, status:'normal', mesh: null };
        let entities=[], bullets=[], loot=[], obstacles=[], popups=[], clouds=[], cranes=[];
        
        // --- 4. Three.js ---
        let scene, camera, renderer, materials={};

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xaaccff);
            scene.fog = new THREE.FogExp2(0xaaccff, 0.0015);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 4000);
            
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas3D'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            renderer.shadowMap.enabled = true;

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(200, 500, 200);
            sun.castShadow = true;
            scene.add(sun);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(CFG.mapSize*2, CFG.mapSize*2), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.4 }));
            floor.rotation.x = -Math.PI / 2; floor.position.y = -10;
            scene.add(floor);

            // Materials
            materials.player = new THREE.MeshStandardMaterial({ color: 0xffaa00, roughness: 0.1 });
            materials.sword = new THREE.MeshStandardMaterial({ color: 0x00aaff, emissive: 0x0044ff, emissiveIntensity:0.5 });
            materials.mob = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5 });
            materials.boss = new THREE.MeshStandardMaterial({ color: 0x8800ff });
            materials.beast = new THREE.MeshStandardMaterial({ color: 0x0088ff, emissive: 0x004488 });
            materials.cloud = new THREE.MeshStandardMaterial({ color: 0xffffff, transparent: true, opacity: 0.8, flatShading: true });
            materials.treeLeaf = new THREE.MeshStandardMaterial({ color: 0xff69b4, flatShading:true }); 
            materials.treeTrunk = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
            materials.loot = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        }

        function genEnvironment() {
            const geo = new THREE.DodecahedronGeometry(15, 0);
            for(let i=0; i<60; i++) {
                const cloud = new THREE.Group();
                for(let j=0; j<4; j++) {
                    const m = new THREE.Mesh(geo, materials.cloud);
                    m.position.set((Math.random()-0.5)*25, (Math.random()-0.5)*10, (Math.random()-0.5)*25);
                    m.scale.setScalar(1+Math.random()); cloud.add(m);
                }
                cloud.position.set((Math.random()-0.5)*CFG.mapSize, 40+Math.random()*60, (Math.random()-0.5)*CFG.mapSize);
                scene.add(cloud); clouds.push({mesh:cloud, spd:0.1+Math.random()*0.2});
            }
            for(let i=0; i<30; i++) {
                const x = Math.random()*CFG.mapSize, y = Math.random()*CFG.mapSize;
                const grp = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(2, 4, 20, 6), materials.treeTrunk);
                trunk.position.y=10;
                const leaves = new THREE.Mesh(new THREE.IcosahedronGeometry(15, 0), materials.treeLeaf);
                leaves.position.y=25;
                grp.add(trunk, leaves);
                grp.position.set(x, 0, y);
                scene.add(grp); obstacles.push(grp); 
            }
            for(let i=0; i<10; i++) {
                const crane = new THREE.Mesh(new THREE.ConeGeometry(2, 8, 4), new THREE.MeshBasicMaterial({color:0xffffff}));
                crane.rotation.x = Math.PI/2;
                scene.add(crane);
                cranes.push({mesh:crane, cx:Math.random()*CFG.mapSize, cy:Math.random()*CFG.mapSize, r:200+Math.random()*200, angle:Math.random()*10, spd:0.5});
            }
        }

        function init() {
            init3D();
            initInput();
            resize();
            window.addEventListener('resize', resize);
            requestAnimationFrame(loop);
        }

        function resize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('hudCanvas').width = window.innerWidth;
            document.getElementById('hudCanvas').height = window.innerHeight;
        }

        function startGame() {
            STATE.mode = 'PLAYING';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            AudioSys.init();

            player.x = CFG.mapSize/2; player.y = CFG.mapSize/2;
            player.v=220; player.lvl=1; player.xp=0; player.nextXp=100;
            
            [...entities, ...bullets, ...loot, ...obstacles, ...clouds, ...cranes].forEach(e => scene.remove(e.mesh||e));
            if(player.mesh) scene.remove(player.mesh);
            entities=[]; bullets=[]; loot=[]; obstacles=[]; popups=[]; clouds=[]; cranes=[];

            player.mesh = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 16), materials.player);
            body.position.y = 5;
            player.mesh.add(body);
            player.swords = [];
            for(let i=0; i<3; i++) {
                const s = new THREE.Mesh(new THREE.ConeGeometry(2, 12, 4), materials.sword);
                s.geometry.rotateX(Math.PI/2);
                const p = new THREE.Group(); p.add(s); s.position.z = 20;
                p.rotation.y = i*(Math.PI*2/3);
                player.mesh.add(p);
                player.swords.push(p);
            }
            scene.add(player.mesh);

            genEnvironment();
            for(let i=0;i<40;i++) spawnEntity('mob');
            for(let i=0;i<10;i++) spawnEntity('beast'); 
            for(let i=0;i<5;i++) spawnEntity('boss');
            for(let i=0;i<120;i++) spawnLoot();
            spawnFinalBoss(CFG.mapSize/2, CFG.mapSize/2);

            addLog("é€é¥å¤©åœ°é—´ï¼Œå¾¡å‰‘ä¹˜é£å»ã€‚", "text-orange-500");
        }

        function loop() {
            if(STATE.mode === 'PLAYING') {
                update(0.016);
                render3D();
                renderHUD();
            }
            requestAnimationFrame(loop);
        }

        function update(dt) {
            STATE.time += dt;
            
            clouds.forEach(c => {
                c.mesh.position.x += c.spd;
                if(c.mesh.position.x > CFG.mapSize) c.mesh.position.x = 0;
            });
            cranes.forEach(c => {
                c.angle += c.spd * dt;
                c.mesh.position.set(c.cx + Math.cos(c.angle)*c.r, 80, c.cy + Math.sin(c.angle)*c.r);
                c.mesh.rotation.y = -c.angle;
            });

            if(player.mesh && player.swords) player.swords.forEach(s => s.rotation.y += dt * 3);

            let moveSpd = 0;
            let moveAngle = 0;
            
            if (input.moveActive) {
                moveSpd = player.baseSpeed * input.movePower;
                moveAngle = input.moveAngle;
            } else if (Object.keys(input.keys).some(k=>input.keys[k])) {
                let dx=0, dy=0;
                if(input.keys['KeyW']) dy-=1; if(input.keys['KeyS']) dy+=1;
                if(input.keys['KeyA']) dx-=1; if(input.keys['KeyD']) dx+=1;
                if(dx!==0||dy!==0) {
                    moveAngle = Math.atan2(dy, dx);
                    moveSpd = player.baseSpeed;
                }
            }

            const finalMoveAngle = moveAngle + input.camAngle + Math.PI/2;

            moveSpd *= (1 + player.lvl * 0.05);
            if(input.keys['ShiftLeft'] || player.skills.speed > 0) moveSpd *= 1.5;

            if(moveSpd > 0.1) {
                player.x += Math.cos(finalMoveAngle) * moveSpd;
                player.y += Math.sin(finalMoveAngle) * moveSpd;
                player.x = Math.max(0, Math.min(CFG.mapSize, player.x));
                player.y = Math.max(0, Math.min(CFG.mapSize, player.y));
                if(player.mesh) player.mesh.rotation.y = -finalMoveAngle + Math.PI/2;
            }
            if(player.mesh) player.mesh.position.set(player.x, 20, player.y);
            
            const camDist = 350;
            const camHeight = 400;
            const camX = player.x + Math.sin(input.camAngle) * camDist;
            const camZ = player.y + Math.cos(input.camAngle) * camDist;
            camera.position.x += (camX - camera.position.x) * 0.1;
            camera.position.z += (camZ - camera.position.z) * 0.1;
            camera.position.y = camHeight;
            camera.lookAt(player.x, 0, player.y);

            if(input.fire && player.shootCd<=0) fireSword(finalMoveAngle); 
            if(player.shootCd>0) player.shootCd-=dt;

            entities.forEach(e => {
                if(e.type !== 'finalBoss') {
                    if(Math.random()<0.01) { e.tx = Math.random()*CFG.mapSize; e.ty = Math.random()*CFG.mapSize; }
                    const adx = e.tx-e.x, ady=e.ty-e.y;
                    if(Math.hypot(adx, ady)>10) {
                        const a = Math.atan2(ady, adx);
                        e.x += Math.cos(a)*e.spd*0.5; e.y += Math.sin(a)*e.spd*0.5;
                        e.mesh.rotation.y = -a + Math.PI/2;
                    }
                }
                e.mesh.position.set(e.x, e.type==='finalBoss'?60:20, e.y);
                if(Math.hypot(player.x-e.x, player.y-e.y) < (e.type==='finalBoss'?100:35)) handleCollision(e);
            });

            for(let i=loot.length-1; i>=0; i--) {
                let l = loot[i];
                l.mesh.rotation.y += dt;
                l.mesh.position.y = 15 + Math.sin(STATE.time*2 + l.x)*3;
                if(Math.hypot(player.x-l.x, player.y-l.y) < 30) {
                    scene.remove(l.mesh); loot.splice(i,1);
                    player.xp += 10; player.v = Math.min(player.maxV, player.v+1);
                    AudioSys.sword();
                }
            }

            for(let i=bullets.length-1; i>=0; i--) {
                let b = bullets[i];
                b.life-=dt; b.x+=Math.cos(b.a)*b.spd; b.y+=Math.sin(b.a)*b.spd;
                b.mesh.position.set(b.x, 20, b.y);
                let hit = false;
                entities.forEach(e => {
                    const hitRad = e.type==='finalBoss' ? 60 : 25;
                    if(Math.hypot(b.x-e.x, b.y-e.y) < hitRad) { damageEntity(e, 30); hit=true; }
                });
                if(hit || b.life<=0) { scene.remove(b.mesh); bullets.splice(i,1); }
            }

            if(player.xp>=player.nextXp) levelUp();
            if(player.skills.shield>0) player.skills.shield-=dt;
            if(player.skills.speed>0) player.skills.speed-=dt;
            if(player.ultCd>0) player.ultCd-=dt;
            
            popups.forEach(p => { p.y+=0.5; p.life-=dt; });
            popups = popups.filter(p=>p.life>0);
            
            updateUI();
        }

        function fireSword(angle) {
            if(player.v<5) return;
            player.v-=3; player.shootCd=0.3;
            AudioSys.sword();
            const m = new THREE.Mesh(new THREE.ConeGeometry(1.5, 10, 8), materials.sword);
            m.geometry.rotateX(Math.PI/2); 
            const shootAng = player.mesh.rotation.y - Math.PI/2;
            m.rotation.y = -shootAng + Math.PI/2;
            scene.add(m);
            bullets.push({x:player.x, y:player.y, a:shootAng, spd:30, life:1.5, mesh:m});
        }
        function startFire(){ input.fire=true; }
        function stopFire(){ input.fire=false; }

        function triggerUltimate() {
            if(player.ultCd > 0) { addLog("CDä¸­...", "text-red-500"); return; }
            startQuiz({type:'ULT'}, true);
        }

        function activateUltEffect() {
            AudioSys.thunder();
            addLog("ä¸‡é›·å¤©ç‰¢å¼•ï¼", "text-purple-600");
            player.ultCd = 30;
            document.body.style.backgroundColor = '#fff';
            setTimeout(()=>document.body.style.backgroundColor = '#87CEEB', 150);
            entities.forEach(e => { if(Math.hypot(player.x-e.x, player.y-e.y) < 800) damageEntity(e, 9999); });
        }

        function handleCollision(e) {
            if(player.skills.shield>0) return;
            player.x -= Math.cos(player.mesh.rotation.y - Math.PI/2)*30; 
            player.y -= Math.sin(player.mesh.rotation.y - Math.PI/2)*30;
            startQuiz(e, false);
        }

        let currentQuiz = null;
        function startQuiz(target, isUlt) {
            STATE.mode = 'QUIZ';
            let pool = QUESTION_DB.simple;
            let title = "æ–©å¦–";
            if(isUlt || target.type === 'boss' || target.type === 'finalBoss') { pool = QUESTION_DB.hard; title = "æ¸¡åŠ«"; }
            const q = pool[Math.floor(Math.random()*pool.length)];
            currentQuiz = { target, q, isUlt };
            document.getElementById('quizModal').style.display = 'flex';
            document.getElementById('quizTitle').innerText = title;
            document.getElementById('quizQuestion').innerText = q.q;
            const od = document.getElementById('quizOptions'); od.innerHTML='';
            q.o.forEach((txt,i)=>{
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 mb-2 bg-gray-50 border border-gray-300 text-gray-800 hover:bg-yellow-100 font-bold rounded shadow-sm";
                b.innerText = txt;
                b.onclick = ()=>endQuiz(i);
                od.appendChild(b);
            });
            AudioSys.speak(q.q);
        }

        function endQuiz(i) {
            AudioSys.stopSpeak();
            document.getElementById('quizModal').style.display = 'none';
            STATE.mode = 'PLAYING';
            if(i === currentQuiz.q.a) {
                if(currentQuiz.isUlt) activateUltEffect();
                else { AudioSys.sword(); damageEntity(currentQuiz.target, 500); addLog("æ–©ï¼", "text-green-600"); }
            } else { player.v -= 50; addLog("å—æŸï¼", "text-red-600"); }
        }

        function damageEntity(e, d) {
            e.hp -= d;
            popups.push({x:e.x, y:e.y, t:`-${d}`, c:'#f00', life:1});
            if(e.hp <= 0) {
                scene.remove(e.mesh);
                entities = entities.filter(x=>x!==e);
                player.xp += (e.type==='mob'?30:100);
                if(e.type==='finalBoss') document.getElementById('winScreen').style.display='flex';
            }
        }

        function spawnEntity(type) {
            const x=Math.random()*CFG.mapSize, y=Math.random()*CFG.mapSize;
            let hp=80, spd=1.5, name="å¿ƒé­”", mat=materials.mob, geo;
            
            if(type==='mob') {
                geo=new THREE.BoxGeometry(10,10,10);
            } else if (type==='beast') {
                name="é›·å…½"; hp=150; spd=3.0; mat=materials.beast;
                geo=new THREE.ConeGeometry(6, 15, 4); 
            } else if (type==='boss') {
                hp=300; spd=2.0; name="é‚ªä¿®"; mat=materials.boss;
                geo=new THREE.CylinderGeometry(5,5,20,8);
            }
            
            const m = new THREE.Mesh(geo, mat); 
            if(type==='beast') { m.rotation.x = Math.PI/2; m.position.y=5; } else { m.position.y=10; }
            scene.add(m);
            entities.push({type, x, y, tx:x, ty:y, spd, hp, maxHp:hp, name, mesh:m});
        }
        function spawnFinalBoss(x,y) {
            const m = new THREE.Group();
            const body = new THREE.Mesh(new THREE.IcosahedronGeometry(25, 1), materials.boss);
            const ring = new THREE.Mesh(new THREE.TorusGeometry(40, 2, 16, 64), new THREE.MeshStandardMaterial({color:0xffd700}));
            m.add(body, ring); scene.add(m);
            entities.push({type:'finalBoss', x, y, tx:x, ty:y, spd:0.5, hp:2000, maxHp:2000, name:"ä¸‡é›·å¤©å°Š", mesh:m});
        }
        function spawnLoot(){
            const x=Math.random()*CFG.mapSize, y=Math.random()*CFG.mapSize;
            const m = new THREE.Mesh(new THREE.OctahedronGeometry(5, 0), materials.loot);
            scene.add(m); loot.push({x,y,mesh:m});
        }

        function updateUI() {
            document.getElementById('voltageDisplay').innerText = "ä¿®ä¸º: " + Math.floor(player.v);
            const rIdx = Math.min(Math.floor(player.lvl/5), REALMS.length-1);
            const subLvl = player.lvl % 5 || 5;
            document.getElementById('levelDisplay').innerText = `${REALMS[rIdx]} ${subLvl}å±‚`;
            
            document.getElementById('hpBar').style.width = (player.v/player.maxV*100)+'%';
            document.getElementById('hpText').innerText = `HP: ${Math.floor(player.v)}/${player.maxV}`;
            
            document.getElementById('xpBar').style.width = (player.xp/player.nextXp*100)+'%';
            document.getElementById('xpText').innerText = `XP: ${Math.floor(player.xp)}/${player.nextXp}`;

            const ultPct = player.ultCd > 0 ? (player.ultCd/30)*100 : 0;
            document.getElementById('ultCd').style.height = ultPct+'%';

            // Fix for missing skillCd visuals
            const s1 = player.skills.shield > 0 ? (player.skills.shield/10)*100 : 0;
            document.getElementById('skillCd1').style.height = s1+'%';
            const s2 = player.skills.speed > 0 ? (player.skills.speed/5)*100 : 0;
            document.getElementById('skillCd2').style.height = s2+'%';
        }
        function levelUp(){ player.lvl++; player.xp=0; player.nextXp*=1.5; addLog("çªç ´ï¼"); }
        function addLog(m,c=''){ 
            const d=document.createElement('div'); d.className=c; d.innerText='> '+m; 
            document.getElementById('logArea').prepend(d); 
        }
        function activateSkill(s){ 
            if(s==='shield'){ player.skills.shield=10; addLog("æŠ¤ä½“"); }
            if(s==='speed'){ player.skills.speed=5; addLog("ç¥è¡Œ"); }
        }

        const hudCtx = document.getElementById('hudCanvas').getContext('2d');
        const miniCtx = document.getElementById('minimapCanvas').getContext('2d');
        function render3D() { renderer.render(scene, camera); }
        function renderHUD() {
            const w = hudCanvas.width, h = hudCanvas.height;
            hudCtx.clearRect(0,0,w,h);
            miniCtx.clearRect(0,0,100,100);

            if(input.moveActive) {
                hudCtx.beginPath(); hudCtx.arc(leftTouch.startX, leftTouch.startY, 50, 0, Math.PI*2);
                hudCtx.strokeStyle='rgba(212, 175, 55, 0.5)'; hudCtx.lineWidth=4; hudCtx.stroke();
                hudCtx.beginPath(); hudCtx.arc(leftTouch.curX, leftTouch.curY, 25, 0, Math.PI*2);
                hudCtx.fillStyle='rgba(255, 215, 0, 0.5)'; hudCtx.fill();
            }

            const toScreen = (x,z) => {
                const v = new THREE.Vector3(x,20,z).project(camera);
                return { x: (v.x*.5+.5)*w, y: (-v.y*.5+.5)*h };
            };

            // Player Floating Bar
            if(player.mesh) {
                const pp = toScreen(player.x, player.y);
                if(pp.x>0 && pp.x<w && pp.y>0 && pp.y<h) {
                    const barW = 50;
                    const hpPct = player.v / player.maxV;
                    
                    hudCtx.fillStyle = '#ffd700';
                    hudCtx.font = 'bold 12px Arial';
                    hudCtx.textAlign = 'center';
                    hudCtx.fillText(`HP: ${Math.floor(player.v)}`, pp.x, pp.y - 55);

                    hudCtx.fillStyle = '#333';
                    hudCtx.fillRect(pp.x - barW/2, pp.y - 50, barW, 6);
                    hudCtx.fillStyle = '#0f0'; 
                    hudCtx.fillRect(pp.x - barW/2, pp.y - 50, barW * hpPct, 6);
                    hudCtx.strokeStyle = '#fff';
                    hudCtx.lineWidth = 1;
                    hudCtx.strokeRect(pp.x - barW/2, pp.y - 50, barW, 6);
                }
            }

            entities.forEach(e => {
                const p = toScreen(e.x, e.y);
                if(p.x>0 && p.x<w && p.y>0 && p.y<h) {
                    hudCtx.fillStyle='#333'; 
                    hudCtx.fillRect(p.x-20, p.y-35, 40, 5);
                    
                    hudCtx.fillStyle=e.type==='finalBoss'?'#800080':'#8b0000'; 
                    const hpRatio = Math.max(0, e.hp/e.maxHp);
                    hudCtx.fillRect(p.x-20, p.y-35, 40*hpRatio, 5);
                    
                    hudCtx.fillStyle='#fff'; 
                    hudCtx.font='bold 10px Arial'; 
                    hudCtx.textAlign='center';
                    hudCtx.fillText(`${Math.floor(e.hp)}/${e.maxHp}`, p.x, p.y-40);
                    
                    hudCtx.fillStyle='#333'; 
                    hudCtx.font='10px serif'; 
                    hudCtx.fillText(e.name, p.x, p.y-22);
                }
                miniCtx.fillStyle='#f00'; miniCtx.fillRect(e.x/CFG.mapSize*100-1, e.y/CFG.mapSize*100-1, 2,2);
            });
            miniCtx.fillStyle='#0ff'; miniCtx.beginPath(); miniCtx.arc(player.x/CFG.mapSize*100, player.y/CFG.mapSize*100, 3, 0, Math.PI*2); miniCtx.fill();

            popups.forEach(p => {
                const sp = toScreen(p.x, p.y);
                hudCtx.fillStyle = p.c; hudCtx.font='bold 16px serif'; hudCtx.fillText(p.t, sp.x, sp.y);
            });
        }

        init();
    </script>
</body>
</html>

